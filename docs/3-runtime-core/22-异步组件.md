# 异步组件
通过 `Promise` 管理组件加载流程，根据加载状态（未加载 / 加载中 / 加载成功 / 加载失败）返回对应内容;

## 状态管理：跟踪组件加载状态
通过三个响应式变量跟踪加载状态：
```ts
export function defineAsyncComponent(options) {
  return {
    setup() {
      const loaded = ref(false); // 标记组件是否加载成功
      const loading = ref(false); // 标记是否处于加载中
      const error = ref(false); // 标记是否加载失败（或超时）
      
      // ... 逻辑处理 ...
      
      // 根据状态返回对应内容
      return () => {
        if (loaded.value) {
          return h(Comp); // 加载成功：渲染组件
        } 
        else if (error.value && errorComponent) {
          return h(errorComponent); // 加载失败：渲染错误组件
        } 
        else if (loading.value && loadingComponent) {
          return h(loadingComponent); // 加载中：渲染加载组件
        } 
        else {
          return h('div'); // 默认占位符（无状态时）
        }
      };
    }
  };
}
```
未加载 → 加载中（loading=true）→ 加载成功（loaded=true）/ 加载失败（error=true）。

## Promise 动态加载组件
`loadFunction` 封装组件加载的 Promise，并处理错误重试：
```ts
function loadFunction() {

  // 调用用户传入的 loader 函数（返回 Promise）
  return loader().catch(err => {

    // 若用户提供了 onError 回调，允许手动处理错误
    if (onError) {
      return new Promise((resolve, reject) => {
        const retry = () => resolve(loadFunction()); // 重试加载
        const fail = () => reject(err); // 标记为失败
        onError(err, retry, fail, ++attempts); // 传回错误和操作函数
      });
    } else {
      throw err; // 未提供 onError 则直接抛出错误
    }
  });
}


// 启动加载
loadFunction()
  .then(comp => {
    Comp = comp; // 保存加载成功的组件
    loaded.value = true; // 更新状态为“加载成功”
  })
  .catch(err => {
    error.value = err; // 更新状态为“加载失败”
  })
  .finally(() => {
    loading.value = false; // 加载完成（无论成败），关闭 loading 状态
    clearTimeout(loadingTimer); // 清理延迟计时器
  });
```


## 加载中：延迟显示加载 & 超时处理
当加载时间极短，则设置延迟时间内不加载（不显示加载组件）；且超出时间视为加载失败，自动触发错误状态；
```ts
// 延迟显示 loading（避免短暂加载导致的闪烁）
let loadingTimer = null;
if (delay) {
  loadingTimer = setTimeout(() => {
    loading.value = true; // 超过 delay 时间仍未加载完成，显示 loading
  }, delay);
}

// 超时处理（超过指定时间视为加载失败）
if (timeout) {
  setTimeout(() => {
    error.value = true; // 标记为失败
    throw new Error('组件加载失败');
  }, timeout);
}
```